CREATE DATABASE IF NOT EXISTS ASYNCORE;

SELECT 'SELECCIONANDO ASYNCORE COMO BASE DE DATOS ACTIVA' AS 'INFO';
USE ASYNCORE;

SELECT 'ELIMINANDO TABLAS SI EXISTEN' AS 'INFO';
DROP TABLE IF EXISTS POST_ETIQUETAS, POSTS, HILO_ETIQUETAS, HILOS, ETIQUETAS, CATEGORIA, TOKENS, USERS, TIPO_USUARIO;

SELECT 'CREANDO TABLA TIPO_USUARIO' AS 'INFO';
CREATE TABLE TIPO_USUARIO
(
    TYPE_ID INT PRIMARY KEY, -- 1 ADMIN 2 PROFESOR 3 ALUMNO
    NOMBRE  VARCHAR(255),
    CONSTRAINT CHK_ID_TIPO CHECK (TYPE_ID IN (1, 2, 3))
);

SELECT 'CREANDO TABLA USERS' AS 'INFO';
CREATE TABLE USERS
(
    USER_ID   INT AUTO_INCREMENT PRIMARY KEY,
    NAME      VARCHAR(255) NOT NULL,
    USERNAME  VARCHAR(255) NOT NULL,
    PASSWORD  VARCHAR(255) NOT NULL,
    EMAIL     VARCHAR(255) NOT NULL,
    F_REG     TIMESTAMP    DEFAULT CURRENT_TIMESTAMP,
    AVATAR    VARCHAR(255) DEFAULT 'img/logo/logo.svg',
    FIRMA     VARCHAR(300),
    USER_TYPE INT          DEFAULT 3,
    CONSTRAINT FK_USERS_ID_TIPO FOREIGN KEY (USER_TYPE) REFERENCES TIPO_USUARIO (TYPE_ID) ON DELETE CASCADE,
    UNIQUE (EMAIL),
    UNIQUE (USERNAME)
);

SELECT 'CREANDO TABLA TOKENS' AS 'INFO';
CREATE TABLE TOKENS
(
    TOKEN_ID INT AUTO_INCREMENT PRIMARY KEY,
    TOKEN    VARCHAR(255) NOT NULL,
    USER_ID  INT          NOT NULL,
    F_CRE    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    F_EXP    TIMESTAMP,
    CONSTRAINT FK_TOKENS_USER_ID FOREIGN KEY (USER_ID) REFERENCES USERS (USER_ID) ON DELETE CASCADE
);

SELECT 'CREANDO TABLA CATEGORIA' AS 'INFO';
CREATE TABLE CATEGORIA
(
    CAT_ID    INT AUTO_INCREMENT PRIMARY KEY,
    TITULO    VARCHAR(255) NOT NULL,
    SUBTITULO VARCHAR(255) NOT NULL,
    ICONO     VARCHAR(255) NOT NULL,
    UNIQUE (TITULO)
);

SELECT 'CREANDO TABLA ETIQUETAS' AS 'INFO';
CREATE TABLE ETIQUETAS
(
    ETI_ID INT AUTO_INCREMENT PRIMARY KEY,
    NOMBRE VARCHAR(255) NOT NULL,
    `DESC` VARCHAR(255) NOT NULL,
    UNIQUE (NOMBRE)
);

SELECT 'CREANDO TABLA HILOS' AS 'INFO';
CREATE TABLE HILOS
(
    THREAD_ID INT AUTO_INCREMENT PRIMARY KEY,
    USER_ID   INT          NOT NULL,
    TITULO    VARCHAR(255) NOT NULL,
    SUBTITULO VARCHAR(255) NOT NULL,
    CONTENIDO TEXT         NOT NULL,
    F_CRE     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    F_EDI     TIMESTAMP DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
    CAT_ID    INT          NOT NULL,
    CONSTRAINT FK_HILOS_USER_ID FOREIGN KEY (USER_ID) REFERENCES USERS (USER_ID) ON DELETE CASCADE,
    CONSTRAINT FK_HILOS_ID_CATEGORIA FOREIGN KEY (CAT_ID) REFERENCES CATEGORIA (CAT_ID) ON DELETE CASCADE
);

SELECT 'CREANDO TABLA POSTS' AS 'INFO';
CREATE TABLE POSTS
(
    POST_ID   INT AUTO_INCREMENT PRIMARY KEY,
    THREAD_ID INT  NOT NULL,
    USER_ID   INT  NOT NULL,
    CONTENIDO TEXT NOT NULL,
    F_CRE     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    F_EDI     TIMESTAMP DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
    CONSTRAINT FK_POSTS_ID_HILO FOREIGN KEY (THREAD_ID) REFERENCES HILOS (THREAD_ID) ON DELETE CASCADE,
    CONSTRAINT FK_POSTS_USER_ID FOREIGN KEY (USER_ID) REFERENCES USERS (USER_ID) ON DELETE CASCADE
);

SELECT 'CREANDO TABLA HILO_ETIQUETAS' AS 'INFO';
CREATE TABLE HILO_ETIQUETAS
(
    THREAD_ID INT NOT NULL,
    ETI_ID    INT NOT NULL,
    PRIMARY KEY (THREAD_ID, ETI_ID),
    CONSTRAINT FK_HILO_ETIQUETAS_ID_HILO FOREIGN KEY (THREAD_ID) REFERENCES HILOS (THREAD_ID) ON DELETE CASCADE,
    CONSTRAINT FK_HILO_ETIQUETAS_ID_ETIQUETA FOREIGN KEY (ETI_ID) REFERENCES ETIQUETAS (ETI_ID) ON DELETE CASCADE
);

SELECT 'CREANDO TABLA POST_ETIQUETAS' AS 'INFO';
CREATE TABLE POST_ETIQUETAS
(
    POST_ID INT NOT NULL,
    ETI_ID  INT NOT NULL,
    PRIMARY KEY (POST_ID, ETI_ID),
    CONSTRAINT FK_POST_ETIQUETAS_ID_POST FOREIGN KEY (POST_ID) REFERENCES POSTS (POST_ID) ON DELETE CASCADE,
    CONSTRAINT FK_POST_ETIQUETAS_ID_ETIQUETA FOREIGN KEY (ETI_ID) REFERENCES ETIQUETAS (ETI_ID) ON DELETE CASCADE
);

SELECT 'SE HAN CREADO TODAS LAS TABLAS CORRECTAMENTE' AS 'INFO';

SELECT 'INSERTANDO DATOS DE PRUEBA' AS 'INFO';

SELECT 'INSERTANDO TIPOS DE USUARIO' AS 'INFO';

INSERT INTO TIPO_USUARIO
VALUES (1, 'ADMIN');
INSERT INTO TIPO_USUARIO
VALUES (2, 'PROFESOR');
INSERT INTO TIPO_USUARIO
VALUES (3, 'USUARIO');

SELECT 'INSERTANDO CATEGORÍAS' AS 'INFO';

INSERT INTO CATEGORIA(TITULO, SUBTITULO, ICONO)
VALUES ('GENERAL', 'FORO GENERAL', '/img/icons/categories/general.png');
INSERT INTO CATEGORIA(TITULO, SUBTITULO, ICONO)
VALUES ('PROGRAMACIÓN SERVIDOR', 'FORO DE PROGRAMACIÓN BACKEND', '/img/icons/categories/backend.png');
INSERT INTO CATEGORIA(TITULO, SUBTITULO, ICONO)
VALUES ('PROGRAMACIÓN CLIENTE', 'FORO DE PROGRAMACIÓN FRONTEND', '/img/icons/categories/frontend.png');
INSERT INTO CATEGORIA(TITULO, SUBTITULO, ICONO)
VALUES ('FRAMEWORKS', 'FORO DE FRAMEWORKS', '/img/icons/categories/frameworks.png');
INSERT INTO CATEGORIA(TITULO, SUBTITULO, ICONO)
VALUES ('OFF-TOPIC', 'FORO OFF-TOPIC', '/img/icons/categories/offtopic.png');

SELECT 'INSERTANDO ETIQUETAS' AS 'INFO';

INSERT INTO ETIQUETAS(NOMBRE, `DESC`)
VALUES ('GENERAL', 'FORO GENERAL');
INSERT INTO ETIQUETAS(NOMBRE, `DESC`)
VALUES ('JAVA', 'PROGRAMACIÓN EN JAVA');
INSERT INTO ETIQUETAS(NOMBRE, `DESC`)
VALUES ('PYTHON', 'PROGRAMACIÓN EN PYTHON');
INSERT INTO ETIQUETAS(NOMBRE, `DESC`)
VALUES ('PHP', 'PROGRAMACIÓN EN PHP');
INSERT INTO ETIQUETAS(NOMBRE, `DESC`)
VALUES ('HTML', 'LENGUAJE DE MARCAS');
INSERT INTO ETIQUETAS(NOMBRE, `DESC`)
VALUES ('CSS', 'HOJAS DE ESTILO');
INSERT INTO ETIQUETAS(NOMBRE, `DESC`)
VALUES ('JAVASCRIPT', 'PROGRAMACIÓN EN JAVASCRIPT');
INSERT INTO ETIQUETAS(NOMBRE, `DESC`)
VALUES ('LARAVEL', 'PROGRAMACIÓN CON LARAVEL');
INSERT INTO ETIQUETAS(NOMBRE, `DESC`)
VALUES ('DJANGO', 'PROGRAMACIÓN CON DJANGO');
INSERT INTO ETIQUETAS(NOMBRE, `DESC`)
VALUES ('MEMES', 'MEMES DE PROGRAMACIÓN');
INSERT INTO ETIQUETAS(NOMBRE, `DESC`)
VALUES ('DUDAS', 'EL USUARIO TIENE DUDAS');
INSERT INTO ETIQUETAS(NOMBRE, `DESC`)
VALUES ('AYUDA', 'EL USUARIO REQUIERE AYUDA');
INSERT INTO ETIQUETAS(NOMBRE, `DESC`)
VALUES ('CÓDIGO', 'REVISIÓN DE CÓDIGO');

SELECT 'INSERTANDO USUARIOS' AS 'INFO';

INSERT INTO USERS(NAME, USERNAME, PASSWORD, EMAIL, FIRMA, USER_TYPE)
VALUES ('Daniel', 'admin', 'Admin1234', 'asyncoreproject@gmail.com', 'Er jefe colegah', 1);
INSERT INTO USERS(NAME, USERNAME, PASSWORD, EMAIL, FIRMA, USER_TYPE)
VALUES ('Jorge', 'Jorge.Dueñas', 'Jorgeduenas01', 'jorge.duenas@educa.madrid.org', 'Er profeh', 2);
INSERT INTO USERS(NAME, USERNAME, PASSWORD, EMAIL, FIRMA, USER_TYPE)
VALUES ('Miguel', 'Miguel.Martinez', 'MiguelMartinez01', 'mmartinez32@educa.madrid.org', 'Er compi', 3);
INSERT INTO USERS(NAME, USERNAME, PASSWORD, EMAIL, FIRMA, USER_TYPE)
VALUES ('Víctor', 'Victor.Hellin', 'VictorHellin01', 'victor.hellin@educa.madrid.org', 'Er compi 2', 3);
INSERT INTO USERS(NAME, USERNAME, PASSWORD, EMAIL, FIRMA, USER_TYPE)
VALUES ('Daniel', 'Daniel.Alonso', 'Danielalonso01', 'dalonso3@educa.madrid.org', 'Er compi 3', 3);
INSERT INTO USERS(NAME, USERNAME, PASSWORD, EMAIL, FIRMA, USER_TYPE)
VALUES ('Maksym', 'Maksym.Dovgan', 'MaksymDovgan01', 'maksym.dovgan@educa.madrid.org', 'Er compi 4', 3);
INSERT INTO USERS(NAME, USERNAME, PASSWORD, EMAIL, FIRMA, USER_TYPE)
VALUES ('Marcos', 'Marcos.Almorox', 'Marcosalmorox01', 'marcos.almorox@educa.madrid.org', 'Er compi 5', 3);

SELECT 'INSERTANDO HILOS' AS 'INFO';

INSERT INTO HILOS(USER_ID, TITULO, SUBTITULO, CONTENIDO, F_CRE, CAT_ID)
VALUES (3, 'Hilo 1 por tricky', 'Holiholi', 'Holi amiwis', '2023-10-17', 1);
INSERT INTO HILOS(USER_ID, TITULO, SUBTITULO, CONTENIDO, F_CRE, CAT_ID)
VALUES (4, 'Hilo 2 por Víctor', 'Llegó el momento, me presento...', 'Holi holi amiwitos', '2023-10-17', 1);
INSERT INTO HILOS(USER_ID, TITULO, SUBTITULO, CONTENIDO, F_CRE, CAT_ID)
VALUES (7, 'Hilo 3 por Marcos', 'Asyncore Rulz!', 'ESTO ES MUCHO MENOS TÓXICO QUE STACKOVERFLOW', '2023-10-17', 1);

SELECT 'INSERTANDO POSTS' AS 'INFO';

INSERT INTO POSTS(THREAD_ID, USER_ID, CONTENIDO, F_CRE)
VALUES (1, 4, 'k PASA TRIKY?', '2023-10-17');
INSERT INTO POSTS(THREAD_ID, USER_ID, CONTENIDO, F_CRE)
VALUES (1, 3, 'POS AKI ANDAMIOS', '2023-10-18');
INSERT INTO POSTS(THREAD_ID, USER_ID, CONTENIDO, F_CRE)
VALUES (1, 4, 'MU BIEN BR0 :D', '2023-10-19');
INSERT INTO POSTS(THREAD_ID, USER_ID, CONTENIDO, F_CRE)
VALUES (1, 5, 'OLEOLE!', '2023-10-20');

INSERT INTO POSTS(THREAD_ID, USER_ID, CONTENIDO, F_CRE)
VALUES (2, 3, 'K PASA VIKTORCÍN?', '2023-10-17');
INSERT INTO POSTS(THREAD_ID, USER_ID, CONTENIDO, F_CRE)
VALUES (2, 4, 'HOLI UwU BIEN', '2023-10-18');
INSERT INTO POSTS(THREAD_ID, USER_ID, CONTENIDO, F_CRE)
VALUES (2, 3, 'Y YO K ME ALEGRO', '2023-10-19');
INSERT INTO POSTS(THREAD_ID, USER_ID, CONTENIDO, F_CRE)
VALUES (2, 5, 'AMOAI!', '2023-10-20');

INSERT INTO POSTS(THREAD_ID, USER_ID, CONTENIDO, F_CRE)
VALUES (3, 6, 'ARO XABAL, ASYNCORE RULZ!', '2023-10-18');
INSERT INTO POSTS(THREAD_ID, USER_ID, CONTENIDO, F_CRE)
VALUES (3, 1, 'AGRADECIDA, Y EMOCIONADA...', '2023-10-19');
INSERT INTO POSTS(THREAD_ID, USER_ID, CONTENIDO, F_CRE)
VALUES (3, 2, '¡QUE STACKOVERFLOW NO ES TÓXICO!', '2023-10-20');
INSERT INTO POSTS(THREAD_ID, USER_ID, CONTENIDO, F_CRE)
VALUES (3, 4, 'OwO', '2023-10-20');

SELECT 'INSERTANDO ETIQUETAS DE HILO' AS 'INFO';

INSERT INTO HILO_ETIQUETAS(THREAD_ID, ETI_ID)
VALUES (1, 1);
INSERT INTO HILO_ETIQUETAS(THREAD_ID, ETI_ID)
VALUES (2, 1);

SELECT 'INSERTANDO ETIQUETAS DE POST' AS 'INFO';

INSERT INTO POST_ETIQUETAS(POST_ID, ETI_ID)
VALUES (1, 1);
INSERT INTO POST_ETIQUETAS(POST_ID, ETI_ID)
VALUES (1, 11);
INSERT INTO POST_ETIQUETAS(POST_ID, ETI_ID)
VALUES (2, 1);
INSERT INTO POST_ETIQUETAS(POST_ID, ETI_ID)
VALUES (2, 11);
INSERT INTO POST_ETIQUETAS(POST_ID, ETI_ID)
VALUES (2, 2);

SELECT 'SE HAN INSERTADO TODOS LOS DATOS DE PRUEBA CORRECTAMENTE' AS 'INFO';

SELECT 'CREANDO PROCEDIMIENTOS ALMACENADOS' AS 'INFO';

SELECT 'CREANDO SHOW_POSTS' AS 'INFO';

DELIMITER //
DROP PROCEDURE IF EXISTS SHOW_POSTS;
CREATE PROCEDURE SHOW_POSTS(IN P_ID_HILO INT)
BEGIN
    DECLARE DONE INT DEFAULT 0;
    DECLARE POST_ID INT;
    DECLARE USER_NAME VARCHAR(255);
    DECLARE POST_CONTENT TEXT;
    DECLARE FECHA_CREACION TIMESTAMP;
    DECLARE FECHA_EDICION TIMESTAMP;

    DECLARE POST_CURSOR CURSOR FOR SELECT POSTS.POST_ID, USERS.USERNAME, POSTS.CONTENIDO, POSTS.F_CRE, POSTS.F_EDI
                                   FROM POSTS
                                            INNER JOIN USERS ON POSTS.USER_ID = USERS.USER_ID
                                   WHERE POSTS.THREAD_ID = P_ID_HILO
                                   ORDER BY POSTS.F_CRE;

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET DONE = TRUE; -- Esto es para decir que el cursor no va a retornar nada

    OPEN POST_CURSOR;

    READ_LOOP:
    LOOP
        FETCH POST_CURSOR INTO POST_ID, USER_NAME, POST_CONTENT, FECHA_CREACION, FECHA_EDICION;
        IF DONE THEN LEAVE READ_LOOP; END IF;
        SELECT POST_ID, USER_NAME, POST_CONTENT, FECHA_CREACION, FECHA_EDICION;
    END LOOP;

    CLOSE POST_CURSOR;
END;
DELIMITER ;

SELECT 'CREANDO SHOW_THREADS' AS 'INFO';

SELECT 'CREANDO PROCEDIMIENTOS DE LOGIN Y REGISTRO' AS 'INFO';

SELECT 'CREANDO LOGIN' AS 'INFO';

DELIMITER //
DROP PROCEDURE IF EXISTS LOGIN;
CREATE PROCEDURE LOGIN(IN P_USERNAME VARCHAR(255), IN P_PASSWORD VARCHAR(255), OUT P_SUCCESS BOOLEAN)
BEGIN
    DECLARE USER_ID INT DEFAULT NULL;
    DECLARE TIPO_USUARIO INT DEFAULT NULL;

    SELECT USER_ID, USER_TYPE
    INTO USER_ID, TIPO_USUARIO
    FROM USERS
    WHERE USERNAME = P_USERNAME AND PASSWORD = P_PASSWORD;

    IF USER_ID IS NOT NULL THEN SET P_SUCCESS = TRUE; ELSE SET P_SUCCESS = FALSE; END IF;
END;
DELIMITER ;

SELECT 'CREANDO REGISTER' AS 'INFO';

DELIMITER //
DROP PROCEDURE IF EXISTS REGISTER;
CREATE PROCEDURE REGISTER(
    IN P_NAME VARCHAR(255),
    IN P_USERNAME VARCHAR(255),
    IN P_PASSWORD VARCHAR(255),
    IN P_EMAIL VARCHAR(255),
    OUT P_SUCCESS BOOLEAN
)
BEGIN
    DECLARE EXISTING_USER_COUNT INT;

    SELECT COUNT(*) INTO EXISTING_USER_COUNT FROM USERS WHERE USERNAME = P_USERNAME;

    IF EXISTING_USER_COUNT > 0 THEN
        SET P_SUCCESS = FALSE;
    ELSE
        INSERT INTO USERS (NAME, USERNAME, PASSWORD, EMAIL) VALUES (P_NAME, P_USERNAME, P_PASSWORD, P_EMAIL);
        SET P_SUCCESS = TRUE;
    END IF;
END;
DELIMITER ;

SELECT 'CREANDO PROCEDIMIENTOS DE ACTUALIZACIÓN DE DATOS DE USUARIO' AS 'INFO';

SELECT 'CREANDO UPDATE_USER' AS 'INFO';
-- UPDATE GENERAL - COALESCE ADMITE NULL PARA DEJAR EL CAMPO SIN UPDATEAR
DROP PROCEDURE IF EXISTS UPDATE_USER;
CREATE PROCEDURE UPDATE_USER(
    IN P_USER_ID INT,
    IN P_USERNAME VARCHAR(255),
    IN P_PASSWORD VARCHAR(255),
    IN P_EMAIL VARCHAR(255),
    IN P_AVATAR VARCHAR(255),
    IN P_FIRMA VARCHAR(255),
    IN P_TIPO_USUARIO INT
)
BEGIN
    UPDATE USERS
    SET USERNAME  = COALESCE(P_USERNAME, USERNAME),
        PASSWORD  = COALESCE(P_PASSWORD, PASSWORD),
        EMAIL     = COALESCE(P_EMAIL, EMAIL),
        AVATAR    = COALESCE(P_AVATAR, AVATAR),
        FIRMA     = COALESCE(P_FIRMA, FIRMA),
        USER_TYPE = COALESCE(P_TIPO_USUARIO, USER_TYPE)
    WHERE USER_ID = P_USER_ID;
END;

SELECT 'CREANDO UPDATE_USERNAME_AND_USERMAIL' AS 'INFO';
-- UPDATE POR CAMPO MAIL O USERNAME - COALESCE ADMITE NULL PARA DEJAR EL CAMPO SIN UPDATEAR
DROP PROCEDURE IF EXISTS UPDATE_USERNAME_AND_USERMAIL;
CREATE PROCEDURE UPDATE_USERNAME_AND_USERMAIL(
    IN P_USER_ID INT,
    IN P_USERNAME VARCHAR(255),
    IN P_EMAIL VARCHAR(255)
)
BEGIN
    UPDATE USERS
    SET USERNAME = COALESCE(P_USERNAME, USERNAME), EMAIL = COALESCE(P_EMAIL, EMAIL)
    WHERE USER_ID = P_USER_ID;
END;

SELECT 'CREANDO UPDATE_PASSWORD' AS 'INFO';
-- UPDATE DE PASSWORD
DROP PROCEDURE IF EXISTS UPDATE_PASSWORD;
CREATE PROCEDURE UPDATE_PASSWORD(
    IN P_USER_ID INT,
    IN P_PASSWORD VARCHAR(255)
)
BEGIN
    UPDATE USERS SET PASSWORD = P_PASSWORD WHERE USER_ID = P_USER_ID;
END;

SELECT 'CREANDO CHANGE_PASSWORD' AS 'INFO';
-- CAMBIO DE PASSWORD - SOLO SI LA NUEVA NO ES IGUAL A LA VIEJA
DROP PROCEDURE IF EXISTS CHANGE_PASSWORD;
CREATE PROCEDURE CHANGE_PASSWORD(
    IN P_USER_ID INT,
    IN P_NEW_PASSWORD VARCHAR(255),
    IN P_OLD_PASSWORD VARCHAR(255)
)
BEGIN
    IF P_OLD_PASSWORD <> P_NEW_PASSWORD THEN
        UPDATE USERS SET PASSWORD = P_NEW_PASSWORD WHERE USER_ID = P_USER_ID;
    END IF;
END;

SELECT 'CREANDO UPDATE_AVATAR_AND_SIGNATURE' AS 'INFO';
-- UPDATE DE AVATAR Y FIRMA - COALESCE ADMITE NULL PARA DEJAR EL CAMPO SIN UPDATEAR
DROP PROCEDURE IF EXISTS UPDATE_AVATAR_AND_SIGNATURE;
CREATE PROCEDURE UPDATE_AVATAR_AND_SIGNATURE(
    IN P_USER_ID INT,
    IN P_AVATAR VARCHAR(255),
    IN P_FIRMA VARCHAR(255)
)
BEGIN
    UPDATE USERS SET AVATAR = COALESCE(P_AVATAR, AVATAR), FIRMA = COALESCE(P_FIRMA, FIRMA) WHERE USER_ID = P_USER_ID;
END;

SELECT 'CREANDO UPDATE_USER_TYPE' AS 'INFO';
-- UPDATE DE TIPO DE USUARIO - SOLO ADMINS
DROP PROCEDURE IF EXISTS UPDATE_USER_TYPE;
CREATE PROCEDURE UPDATE_USER_TYPE(
    IN P_USER_ID INT,
    IN P_TIPO_USUARIO INT
)
BEGIN
    UPDATE USERS SET USER_TYPE = P_TIPO_USUARIO WHERE USER_ID = P_USER_ID;
END;

DELIMITER ;

SELECT 'FIN DE PROCEDIMIENTOS DE ACTUALIZACIÓN DE DATOS DE USUARIO' AS 'INFO';

SELECT 'CREANDO PROCEDIMIENTOS DE MANEJO DE HILOS Y POSTS' AS 'INFO';

SELECT 'CREANDO NEW_THREAD' AS 'INFO';

DELIMITER //
DROP PROCEDURE IF EXISTS NEW_THREAD;
CREATE PROCEDURE NEW_THREAD(
    IN P_USER_ID INT,
    IN P_TITULO VARCHAR(255),
    IN P_SUBTITULO VARCHAR(255),
    IN P_CONTENIDO TEXT,
    IN P_ID_CATEGORIA INT
)
BEGIN
    INSERT INTO HILOS (USER_ID, TITULO, SUBTITULO, CONTENIDO, F_CRE, CAT_ID)
    VALUES (P_USER_ID, P_TITULO, P_SUBTITULO, P_CONTENIDO, NOW(), P_ID_CATEGORIA);
    /*Esto es para insertar el primer post del hilo
    INSERT INTO POSTS (ID_HILO, USER_ID, CONTENIDO)
    VALUES (LAST_INSERT_ID(), p_user_id, p_contenido);
    Eliminar sin miedo en caso de que no sea necesario.*/
END;
DELIMITER ;

SELECT 'CREANDO NEW_POST' AS 'INFO';

DELIMITER //
DROP PROCEDURE IF EXISTS NEW_POST;
CREATE PROCEDURE NEW_POST(
    IN P_ID_HILO INT,
    IN P_USER_ID INT,
    IN P_CONTENIDO TEXT
)
BEGIN
    INSERT INTO POSTS (THREAD_ID, USER_ID, CONTENIDO, F_CRE) VALUES (P_ID_HILO, P_USER_ID, P_CONTENIDO, NOW());
END;
DELIMITER ;

SELECT 'CREANDO TOP_THREADS_BY_POSTS' AS 'INFO';

DELIMITER //
DROP PROCEDURE IF EXISTS TOP_THREADS_BY_POSTS;
CREATE PROCEDURE TOP_THREADS_BY_POSTS()
BEGIN
    DECLARE NUM_THREADS INT;
    SET NUM_THREADS = 5;
    SELECT HILOS.THREAD_ID, TITULO, COUNT(POSTS.POST_ID) AS NUMERO_POSTS
    FROM HILOS
             LEFT JOIN POSTS ON HILOS.THREAD_ID = POSTS.THREAD_ID
    GROUP BY HILOS.THREAD_ID, TITULO
    ORDER BY NUMERO_POSTS DESC
    LIMIT NUM_THREADS;
END;
DELIMITER ;

SELECT 'CREANDO LATEST_THREADS' AS 'INFO';

DELIMITER //
DROP PROCEDURE IF EXISTS LATEST_THREADS;
CREATE PROCEDURE LATEST_THREADS(IN NUM_HILOS INT)
BEGIN
    SELECT THREAD_ID, USER_ID, TITULO, CONTENIDO, F_CRE, F_EDI, CAT_ID FROM HILOS ORDER BY F_CRE DESC LIMIT NUM_HILOS;
END;
DELIMITER ;

SELECT 'CREANDO LATEST_POSTS' AS 'INFO';

DELIMITER //
DROP PROCEDURE IF EXISTS LATEST_POSTS;
CREATE PROCEDURE LATEST_POSTS(IN NUM_POSTS INT)
BEGIN
    SELECT THREAD_ID, USER_ID, TITULO, CONTENIDO, F_CRE, F_EDI, CAT_ID FROM HILOS ORDER BY F_CRE DESC LIMIT NUM_POSTS;
END;
DELIMITER ;

SELECT 'FIN DE PROCEDIMIENTOS DE MANEJO DE HILOS Y POSTS' AS 'INFO';

SELECT 'CREANDO PROCEDIMIENTOS DE MANEJO DE ETIQUETAS' AS 'INFO';