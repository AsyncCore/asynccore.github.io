USE ASYNCORE;

DROP TABLE IF EXISTS POST_ETIQUETAS, POSTS, HILO_ETIQUETAS, HILOS, ETIQUETAS, CATEGORIA, USERS, TIPO_USUARIO;

CREATE TABLE TIPO_USUARIO
(
    ID_TIPO INT PRIMARY KEY, -- 1 ADMIN 2 PROFESOR 3 ALUMNO
    NOMBRE  VARCHAR(255),
    CONSTRAINT CHK_ID_TIPO CHECK (ID_TIPO IN (1, 2, 3))
);

CREATE TABLE USERS
(
    USER_ID        INT AUTO_INCREMENT PRIMARY KEY,
    USERNAME       VARCHAR(255) NOT NULL,
    PASSWORD       VARCHAR(255) NOT NULL,
    EMAIL          VARCHAR(255) NOT NULL,
    FECHA_REGISTRO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    AVATAR         VARCHAR(255),
    FIRMA          VARCHAR(255),
    TIPO_USUARIO   INT       DEFAULT 2,
    CONSTRAINT FK_USERS_ID_TIPO FOREIGN KEY (TIPO_USUARIO)
        REFERENCES TIPO_USUARIO (ID_TIPO) ON DELETE CASCADE,
    UNIQUE (EMAIL),
    UNIQUE (USERNAME)
);

CREATE TABLE CATEGORIA
(
    ID_CATEGORIA INT AUTO_INCREMENT PRIMARY KEY,
    TITULO       VARCHAR(255) NOT NULL,
    SUBTITULO    VARCHAR(255) NOT NULL,
    ICONO        VARCHAR(255) DEFAULT NULL,
    UNIQUE (TITULO)
);

CREATE TABLE ETIQUETAS
(
    ID_ETIQUETA INT AUTO_INCREMENT PRIMARY KEY,
    NOMBRE      VARCHAR(255) NOT NULL,
    DESCRIPCION VARCHAR(255) NOT NULL,
    UNIQUE (NOMBRE)
);

CREATE TABLE HILOS
(
    ID_HILO        INT AUTO_INCREMENT PRIMARY KEY,
    USER_ID        INT          NOT NULL,
    TITULO         VARCHAR(255) NOT NULL,
    CONTENIDO      TEXT         NOT NULL,
    FECHA_CREACION TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FECHA_EDICION  TIMESTAMP DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
    ID_CATEGORIA   INT          NOT NULL,
    CONSTRAINT FK_HILOS_USER_ID FOREIGN KEY (USER_ID)
        REFERENCES USERS (USER_ID) ON DELETE CASCADE,
    CONSTRAINT FK_HILOS_ID_CATEGORIA FOREIGN KEY (ID_CATEGORIA)
        REFERENCES CATEGORIA (ID_CATEGORIA) ON DELETE CASCADE
);

CREATE TABLE POSTS
(
    ID_POST        INT AUTO_INCREMENT PRIMARY KEY,
    ID_HILO        INT  NOT NULL,
    USER_ID        INT  NOT NULL,
    CONTENIDO      TEXT NOT NULL,
    FECHA_CREACION TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FECHA_EDICION  TIMESTAMP DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
    CONSTRAINT FK_POSTS_ID_HILO FOREIGN KEY (ID_HILO)
        REFERENCES HILOS (ID_HILO) ON DELETE CASCADE,
    CONSTRAINT FK_POSTS_USER_ID FOREIGN KEY (USER_ID)
        REFERENCES USERS (USER_ID) ON DELETE CASCADE
);

CREATE TABLE HILO_ETIQUETAS
(
    ID_HILO     INT NOT NULL,
    ID_ETIQUETA INT NOT NULL,
    PRIMARY KEY (ID_HILO, ID_ETIQUETA),
    CONSTRAINT FK_HILO_ETIQUETAS_ID_HILO FOREIGN KEY (ID_HILO)
        REFERENCES HILOS (ID_HILO) ON DELETE CASCADE,
    CONSTRAINT FK_HILO_ETIQUETAS_ID_ETIQUETA FOREIGN KEY (ID_ETIQUETA)
        REFERENCES ETIQUETAS (ID_ETIQUETA) ON DELETE CASCADE
);

CREATE TABLE POST_ETIQUETAS
(
    ID_POST     INT NOT NULL,
    ID_ETIQUETA INT NOT NULL,
    PRIMARY KEY (ID_POST, ID_ETIQUETA),
    CONSTRAINT FK_POST_ETIQUETAS_ID_POST FOREIGN KEY (ID_POST)
        REFERENCES POSTS (ID_POST) ON DELETE CASCADE,
    CONSTRAINT FK_POST_ETIQUETAS_ID_ETIQUETA FOREIGN KEY (ID_ETIQUETA)
        REFERENCES ETIQUETAS (ID_ETIQUETA) ON DELETE CASCADE
);