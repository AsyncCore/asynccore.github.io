SELECT 'SELECCIONANDO ASYNCORE COMO BASE DE DATOS ACTIVA' AS 'INFO';
USE ASYNCORE;

SELECT 'ELIMINANDO TABLAS SI EXISTEN' AS 'INFO';
DROP TABLE IF EXISTS POST_ETIQUETAS, POSTS, HILO_ETIQUETAS, HILOS, ETIQUETAS, CATEGORIA, USERS, TOKENS, TIPO_USUARIO;

SELECT 'CREANDO TABLA TIPO_USUARIO' AS 'INFO';
CREATE TABLE TIPO_USUARIO
(
    ID_TIPO INT PRIMARY KEY, -- 1 ADMIN 2 PROFESOR 3 ALUMNO
    NOMBRE  VARCHAR(255),
    CONSTRAINT CHK_ID_TIPO CHECK (ID_TIPO IN (1, 2, 3))
);

SELECT 'CREANDO TABLA USERS' AS 'INFO';
CREATE TABLE USERS
(
    USER_ID        INT AUTO_INCREMENT PRIMARY KEY,
    NAME           VARCHAR(255) NOT NULL,
    USERNAME       VARCHAR(255) NOT NULL,
    PASSWORD       VARCHAR(255) NOT NULL,
    EMAIL          VARCHAR(255) NOT NULL,
    FECHA_REGISTRO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    AVATAR         VARCHAR(255),
    FIRMA          VARCHAR(300),
    TIPO_USUARIO   INT       DEFAULT 3,
    CONSTRAINT FK_USERS_ID_TIPO FOREIGN KEY (TIPO_USUARIO)
        REFERENCES TIPO_USUARIO (ID_TIPO) ON DELETE CASCADE,
    UNIQUE (EMAIL),
    UNIQUE (USERNAME)
);

SELECT 'CREANDO TABLA TOKENS' AS 'INFO';
CREATE TABLE TOKENS(
    ID_TOKEN INT AUTO_INCREMENT PRIMARY KEY,
    TOKEN VARCHAR(255) NOT NULL,
    USER_ID INT NOT NULL,
    FECHA_CREA TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FECHA_EXP TIMESTAMP,
    CONSTRAINT FK_TOKENS_USER_ID FOREIGN KEY (USER_ID)
       REFERENCES USERS (USER_ID) ON DELETE CASCADE
);

SELECT 'CREANDO TABLA CATEGORIA' AS 'INFO';
CREATE TABLE CATEGORIA
(
    ID_CAT INT AUTO_INCREMENT PRIMARY KEY,
    TITULO       VARCHAR(255) NOT NULL,
    SUBTITULO    VARCHAR(255) NOT NULL,
    ICONO        VARCHAR(255) DEFAULT NULL,
    UNIQUE (TITULO)
);

SELECT 'CREANDO TABLA ETIQUETAS' AS 'INFO';
CREATE TABLE ETIQUETAS
(
    ID_ETIQUETA INT AUTO_INCREMENT PRIMARY KEY,
    NOMBRE      VARCHAR(255) NOT NULL,
    DESCRIPCION VARCHAR(255) NOT NULL,
    UNIQUE (NOMBRE)
);

SELECT 'CREANDO TABLA HILOS' AS 'INFO';
CREATE TABLE HILOS
(
    ID_HILO        INT AUTO_INCREMENT PRIMARY KEY,
    USER_ID        INT          NOT NULL,
    TITULO         VARCHAR(255) NOT NULL,
    CONTENIDO      TEXT         NOT NULL,
    FECHA_CREACION TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FECHA_EDICION  TIMESTAMP DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
    ID_CAT         INT          NOT NULL,
    CONSTRAINT FK_HILOS_USER_ID FOREIGN KEY (USER_ID)
        REFERENCES USERS (USER_ID) ON DELETE CASCADE,
    CONSTRAINT FK_HILOS_ID_CATEGORIA FOREIGN KEY (ID_CAT)
        REFERENCES CATEGORIA (ID_CAT) ON DELETE CASCADE
);

SELECT 'CREANDO TABLA POSTS' AS 'INFO';
CREATE TABLE POSTS
(
    ID_POST        INT AUTO_INCREMENT PRIMARY KEY,
    ID_HILO        INT  NOT NULL,
    USER_ID        INT  NOT NULL,
    CONTENIDO      TEXT NOT NULL,
    FECHA_CREACION TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FECHA_EDICION  TIMESTAMP DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
    CONSTRAINT FK_POSTS_ID_HILO FOREIGN KEY (ID_HILO)
        REFERENCES HILOS (ID_HILO) ON DELETE CASCADE,
    CONSTRAINT FK_POSTS_USER_ID FOREIGN KEY (USER_ID)
        REFERENCES USERS (USER_ID) ON DELETE CASCADE
);

SELECT 'CREANDO TABLA HILO_ETIQUETAS' AS 'INFO';
CREATE TABLE HILO_ETIQUETAS
(
    ID_HILO     INT NOT NULL,
    ID_ETIQUETA INT NOT NULL,
    PRIMARY KEY (ID_HILO, ID_ETIQUETA),
    CONSTRAINT FK_HILO_ETIQUETAS_ID_HILO FOREIGN KEY (ID_HILO)
        REFERENCES HILOS (ID_HILO) ON DELETE CASCADE,
    CONSTRAINT FK_HILO_ETIQUETAS_ID_ETIQUETA FOREIGN KEY (ID_ETIQUETA)
        REFERENCES ETIQUETAS (ID_ETIQUETA) ON DELETE CASCADE
);

SELECT 'CREANDO TABLA POST_ETIQUETAS' AS 'INFO';
CREATE TABLE POST_ETIQUETAS
(
    ID_POST     INT NOT NULL,
    ID_ETIQUETA INT NOT NULL,
    PRIMARY KEY (ID_POST, ID_ETIQUETA),
    CONSTRAINT FK_POST_ETIQUETAS_ID_POST FOREIGN KEY (ID_POST)
        REFERENCES POSTS (ID_POST) ON DELETE CASCADE,
    CONSTRAINT FK_POST_ETIQUETAS_ID_ETIQUETA FOREIGN KEY (ID_ETIQUETA)
        REFERENCES ETIQUETAS (ID_ETIQUETA) ON DELETE CASCADE
);

SELECT 'SE HAN CREADO TODAS LAS TABLAS CORRECTAMENTE' AS 'INFO';