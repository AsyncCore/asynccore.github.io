SELECT 'SELECCIONANDO ASYNCORE COMO BASE DE DATOS ACTIVA' AS 'INFO';
USE ASYNCORE;

SELECT 'ELIMINANDO TABLAS SI EXISTEN' AS 'INFO';
DROP TABLE IF EXISTS POST_ETIQUETAS, POSTS, HILO_ETIQUETAS, HILOS, ETIQUETAS, CATEGORIA, USERS, TOKENS, TIPO_USUARIO;

SELECT 'CREANDO TABLA TIPO_USUARIO' AS 'INFO';
CREATE TABLE TIPO_USUARIO
(
    TYPE_ID INT PRIMARY KEY, -- 1 ADMIN 2 PROFESOR 3 ALUMNO
    NOMBRE  VARCHAR(255),
    CONSTRAINT CHK_ID_TIPO CHECK (TYPE_ID IN (1, 2, 3))
);

SELECT 'CREANDO TABLA USERS' AS 'INFO';
CREATE TABLE USERS
(
    USER_ID      INT AUTO_INCREMENT PRIMARY KEY,
    NAME         VARCHAR(255) NOT NULL,
    USERNAME     VARCHAR(255) NOT NULL,
    PASSWORD     VARCHAR(255) NOT NULL,
    EMAIL        VARCHAR(255) NOT NULL,
    F_REG        TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    AVATAR       VARCHAR(255),
    FIRMA        VARCHAR(300),
    USER_TYPE    INT       DEFAULT 3,
    LAST_SEEN    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT FK_USERS_ID_TIPO FOREIGN KEY (USER_TYPE)
        REFERENCES TIPO_USUARIO (TYPE_ID) ON DELETE CASCADE,
    UNIQUE (EMAIL),
    UNIQUE (USERNAME)
);

SELECT 'CREANDO TABLA TOKENS' AS 'INFO';
CREATE TABLE TOKENS
(
    TOKEN_ID INT AUTO_INCREMENT PRIMARY KEY,
    TOKEN    VARCHAR(255) NOT NULL,
    USER_ID  INT          NOT NULL,
    F_CRE    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    F_EXP    TIMESTAMP,
    CONSTRAINT FK_TOKENS_USER_ID FOREIGN KEY (USER_ID)
        REFERENCES USERS (USER_ID) ON DELETE CASCADE
);

SELECT 'CREANDO TABLA CATEGORIA' AS 'INFO';
CREATE TABLE CATEGORIA
(
    CAT_ID    INT AUTO_INCREMENT PRIMARY KEY,
    TITULO    VARCHAR(255) NOT NULL,
    SUBTITULO VARCHAR(255) NOT NULL,
    ICONO     VARCHAR(255) NOT NULL,
    UNIQUE (TITULO)
);

SELECT 'CREANDO TABLA ETIQUETAS' AS 'INFO';
CREATE TABLE ETIQUETAS
(
    ETI_ID INT AUTO_INCREMENT PRIMARY KEY,
    NOMBRE VARCHAR(255) NOT NULL,
    `DESC` VARCHAR(255) NOT NULL,
    ICONO VARCHAR(255) NOT NULL,
    UNIQUE (NOMBRE)
);

SELECT 'CREANDO TABLA HILOS' AS 'INFO';
CREATE TABLE HILOS
(
    THREAD_ID   INT AUTO_INCREMENT PRIMARY KEY,
    USER_ID   INT          NOT NULL,
    TITULO    VARCHAR(255) NOT NULL,
    SUBTITULO VARCHAR(255) NOT NULL,
    CONTENIDO TEXT         NOT NULL,
    F_CRE     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    F_EDI     TIMESTAMP DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
    CAT_ID    INT          NOT NULL,
    CONSTRAINT FK_HILOS_USER_ID FOREIGN KEY (USER_ID)
        REFERENCES USERS (USER_ID) ON DELETE CASCADE,
    CONSTRAINT FK_HILOS_ID_CATEGORIA FOREIGN KEY (CAT_ID)
        REFERENCES CATEGORIA (CAT_ID) ON DELETE CASCADE
);

SELECT 'CREANDO TABLA POSTS' AS 'INFO';
CREATE TABLE POSTS
(
    POST_ID   INT AUTO_INCREMENT PRIMARY KEY,
    THREAD_ID INT  NOT NULL,
    USER_ID   INT  NOT NULL,
    CONTENIDO TEXT NOT NULL,
    F_CRE     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    F_EDI     TIMESTAMP DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
    REPLY_ID  INT,
    CONSTRAINT FK_POSTS_ID_HILO FOREIGN KEY (THREAD_ID)
        REFERENCES HILOS (THREAD_ID) ON DELETE CASCADE,
    CONSTRAINT FK_POSTS_USER_ID FOREIGN KEY (USER_ID)
        REFERENCES USERS (USER_ID) ON DELETE CASCADE,
    CONSTRAINT FK_POSTS_REPLY_ID FOREIGN KEY (REPLY_ID)
        REFERENCES POSTS (POST_ID) ON DELETE CASCADE
);

SELECT 'CREANDO TABLA HILO_ETIQUETAS' AS 'INFO';
CREATE TABLE HILO_ETIQUETAS
(
    THREAD_ID INT NOT NULL,
    ETI_ID  INT NOT NULL,
    PRIMARY KEY (THREAD_ID, ETI_ID),
    CONSTRAINT FK_HILO_ETIQUETAS_ID_HILO FOREIGN KEY (THREAD_ID)
        REFERENCES HILOS (THREAD_ID) ON DELETE CASCADE,
    CONSTRAINT FK_HILO_ETIQUETAS_ID_ETIQUETA FOREIGN KEY (ETI_ID)
        REFERENCES ETIQUETAS (ETI_ID) ON DELETE CASCADE
);

SELECT 'CREANDO TABLA POST_ETIQUETAS' AS 'INFO';
CREATE TABLE POST_ETIQUETAS
(
    POST_ID INT NOT NULL,
    ETI_ID  INT NOT NULL,
    PRIMARY KEY (POST_ID, ETI_ID),
    CONSTRAINT FK_POST_ETIQUETAS_ID_POST FOREIGN KEY (POST_ID)
        REFERENCES POSTS (POST_ID) ON DELETE CASCADE,
    CONSTRAINT FK_POST_ETIQUETAS_ID_ETIQUETA FOREIGN KEY (ETI_ID)
        REFERENCES ETIQUETAS (ETI_ID) ON DELETE CASCADE
);

SELECT 'SE HAN CREADO TODAS LAS TABLAS CORRECTAMENTE' AS 'INFO';